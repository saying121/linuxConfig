# put to /etc/dae/config.dae
global {
    # tproxyç›‘å¬ç«¯å£
    tproxy_port: 12345

    # è®¾ç½®ä¸ºtrueå¼€å¯å¯ä¿æŠ¤tproxyç«¯å£ä¸å—æœªç»è¯·æ±‚çš„æµé‡çš„å½±å“
    tproxy_port_protect: true

    # so_markæ ‡è®°ç½‘ç»œæ•°æ®åŒ…ï¼Œå¦‚æžœä¸ä¸ºé›¶ï¼Œåˆ™ä»Ž dae å‘é€çš„æµé‡å°†è¢«è®¾ç½®ä¸º SO_MARK
    so_mark_from_dae: 0

    # æ—¥å¿—çº§åˆ«: error, warn, info, debug, trace.
    log_level: info

    # æ˜¯å¦ç¦æ­¢ç­‰å¾…ç½‘ç»œï¼Œåœ¨æ‹‰å–è®¢é˜…ä¹‹å‰
    disable_waiting_network: false

    ##### ç½‘ç»œæŽ¥å£å’Œå†…æ ¸é€‰é¡¹
    # å¦‚æžœä½ éœ€è¦ä¸ºå…¶ä»–å±€åŸŸç½‘è®¾å¤‡æä¾›ä»£ç†ï¼Œéœ€è¦ç»‘å®šLANæŽ¥å£ï¼Œå¤šä¸ªç½‘å¡","åˆ†å‰²
    lan_interface: eth0,docker0

    # å¦‚æžœä½ è¦ä»£ç†æœ¬æœºæµé‡ï¼Œéœ€è¦ç»‘å®šWANæŽ¥å£ï¼Œå¤šä¸ªæŽ¥å£","åˆ†å‰²ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªåŠ¨æ£€æµ‹"auto"
    wan_interface: auto

    # è‡ªåŠ¨é…ç½®Linuxå†…æ ¸å‚æ•°ã€‚ip_forwardå’Œsend_redirects
    auto_config_kernel_parameter: true

    ##### èŠ‚ç‚¹è¿žé€šæ€§æ£€æŸ¥
    # å¦‚æžœä½ ä¸»æœºæœ‰åŒæ ˆçš„è¯ï¼Œæ£€æŸ¥é“¾æŽ¥éœ€è¦æœ‰IPV4å’ŒIPV6
    # ç¬¬ä¸€ä¸ªæ˜¯URLï¼Œå…¶ä»–å¯ä»¥æŒ‡å®šIP
    # è€ƒè™‘åˆ°æµé‡æ¶ˆè€—ï¼Œå»ºè®®é€‰æ‹©anycast IPï¼ˆCDNï¼‰ã€å“åº”æ•°æ®å°‘çš„ç«™ç‚¹ã€‚
    #tcp_check_url: 'http://cp.cloudflare.com'
    tcp_check_url: 'http://cp.cloudflare.com,1.1.1.1,2606:4700:4700::1111'

    # æ£€æŸ¥çš„HTTPè¯·æ±‚æ–¹æ³•
    tcp_check_http_method: HEAD

    # ç”¨äºŽæ£€æŸ¥èŠ‚ç‚¹çš„UDPè¿žæŽ¥. å¦‚æžœdns_upstreamé…ç½®åŒ…å« tcp, åŒæ ·å¯ä»¥ç”¨æ¥æ£€æŸ¥TCPèŠ‚ç‚¹
    # ç¬¬ä¸€ä¸ªæ˜¯URLï¼Œå…¶ä»–æ˜¯IP
    # å¦‚æžœä½ ä¸»æœºæœ‰åŒæ ˆçš„è¯ï¼ŒIPV4å’ŒIPV6éƒ½éœ€è¦æŒ‡å®š
    #udp_check_dns: 'dns.google.com:53'
    udp_check_dns: 'dns.google.com:53,8.8.8.8,2001:4860:4860::8888'

    # æ£€æŸ¥é—´éš”
    check_interval: 30s

    # å½“èŠ‚ç‚¹å»¶è¿Ÿå·®å¤šå°‘ä¼šåˆ‡æ¢èŠ‚ç‚¹
    check_tolerance: 50ms


    ##### è¿žæŽ¥é€‰é¡¹.
    # æ‹¨å·æ¨¡å¼ï¼šip,domain,domain+,domain++
    dial_mode: domain

    # æ˜¯å¦å…è®¸ä¸å®‰å…¨çš„TLSè¯ä¹¦
    allow_insecure: false

    # ç­‰å¾…ç¬¬ä¸€æ¬¡å—…æŽ¢æ•°æ®å‘é€çš„è¶…æ—¶æ—¶é—´
    # å¦‚æžœdial_modeæ˜¯ipï¼Œé‚£ä¹ˆè®¾ç½®ä¸º0
    sniffing_timeout: 100ms

    # tlså®žçŽ°ï¼Œè®¾ç½®ä¸ºtlsåˆ™ä½¿ç”¨crypto/tlsï¼Œè®¾ç½®ä¸ºutlsåˆ™ä½¿ç”¨uTLSï¼Œå¯ä»¥æ¨¡ä»¿æµè§ˆå™¨çš„æŒ‡çº¹
    tls_implementation: utls

    # utlsè¦æ¨¡ä»¿çš„å®¢æˆ·ç«¯ï¼Œä»…å½“utlsæ—¶ç”Ÿæ•ˆ
    # å‚è€ƒ httpsï¼š//github.com/daeuniverse/dae/blob/331fa23c16/component/outbound/transport/tls/utls.go#L17
    utls_imitate: chrome_auto
}

subscription {
  # åœ¨ä¸‹é¢å¡«å…¥ä½ çš„è®¢é˜…é“¾æŽ¥ã€‚
  sf: ""
  # fny: ''
}

# æ›´å¤šçš„ DNS æ ·ä¾‹è§ https://github.com/daeuniverse/dae/blob/main/docs/en/configuration/dns.md
dns {
  upstream {
    googledns: 'tcp+udp://dns.google.com:53'
    alidns: 'udp://dns.alidns.com:53'
  }
    routing {
        # æ ¹æ®DNSæŸ¥è¯¢çš„è¯·æ±‚ï¼Œå†³å®šä½¿ç”¨å“ªä¸ªDNSæœåŠ¡å™¨
        # è§„åˆ™ä»Žä¸Šåˆ°ä¸‹åŒ¹é…
        request {
            # å†…ç½®å‡ºç«™:asis,reject
            # å¯ç”¨çš„æ–¹æ³•qname, qtype
            # å¹¿å‘Šæ‹’ç»
            qname(geosite:category-ads-all) -> reject
            # è¿™é‡Œçš„æ„æ€æ˜¯googleä¸­æ˜¯cnçš„åŸŸåä½¿ç”¨alidns
            qname(geosite:google@cn) -> alidns
            # åŒ¹é…åŽç¼€ï¼ŒåŒ¹é…å…³é”®å­—
            # qname(suffix: abc.com, keyword: google) -> googledns
            qname(keyword: google, keyword: bing) -> googledns
            # å…¨åŒ¹é…å’Œæ­£åˆ™åŒ¹é…
            # qname(full: ok.com, regex: '^yes') -> googledns
             # DNS è¯·æ±‚ç±»åž‹
             # ipv4å’Œipv6è¯·æ±‚ä½¿ç”¨alidns
            # qtype(a, aaaa) -> alidns
            # cnameè¯·æ±‚googledns
            # qtype(cname) -> googledns
            # é»˜è®¤DNSæœåŠ¡å™¨
            fallback: googledns
        }
        # æ ¹æ®DNSæŸ¥è¯¢çš„å“åº”ï¼Œå†³å®šæŽ¥å—æˆ–è€…ä½¿ç”¨å¦å¤–ä¸€ä¸ªDNSæœåŠ¡å™¨é‡æ–°æŸ¥è¯¢è®°å½•
        # è§„åˆ™ä»Žä¸Šåˆ°ä¸‹åŒ¹é…
        response {
            # å†…ç½®å‡ºç«™ï¼šaccept,reject
            # å¯ç”¨çš„æ–¹æ³•ï¼šqname, qtype, upstream, ip.
            # å¦‚æžœæ˜¯å‘é€åˆ°googlednsçš„è¯·æ±‚å“åº”ï¼Œåˆ™æŽ¥å—ï¼Œå¯ç”¨äºŽé¿å…å¾ªçŽ¯
            upstream(googledns) -> accept
            # æ„æ€æ˜¯å¦‚æžœè¯·æ±‚çš„åŸŸåä¸æ˜¯å›½å†…ç½‘ç«™ï¼Œä½†æ˜¯è¿”å›žäº†ä¸€ä¸ªç§æœ‰çš„IPï¼Œé‚£å°±æ˜¯è¢«æ±¡æŸ“äº†ã€‚é‡æ–°é€šè¿‡googlednsè¯·æ±‚
            ip(geoip:private) && !qname(geosite:cn) -> googledns
            # ä»¥ä¸Šä¸åŒ¹é…ï¼Œé»˜è®¤
            fallback: accept
        }
    }
}

group {
    proxy_all {
        filter: !name(keyword: "æ—¥æœ¬")
        policy: min_moving_avg
    }
    Bing {
        filter: name(keyword: 'æ–°åŠ å¡', keyword: "ðŸ‡¸ðŸ‡¬", regex: '(?i)Singapore',
            regex: '(?i)chatgpt',
            keyword: 'ç¾Žå›½', keyword: "ðŸ‡ºðŸ‡¸", regex: '(?i)America',
            keyword: 'è‹±å›½')
        policy: min_moving_avg
    }
    Google {
        filter: name(regex: '(?i)HK', keyword: "é¦™æ¸¯", regex: '(?i)Hongkong',
            keyword: 'æ–°åŠ å¡', keyword: "ðŸ‡¸ðŸ‡¬", regex: '(?i)Singapore',
            regex: '(?i)chatgpt',
            keyword: 'å°æ¹¾', regex: "(?i)Taiwan",
            keyword: 'ç¾Žå›½', keyword: "ðŸ‡ºðŸ‡¸", regex: '(?i)America',
            keyword: 'è‹±å›½')
        policy: min_moving_avg
    }
    Hongkong {
        filter: name(keyword: 'HK', keyword: "é¦™æ¸¯", regex: '(?i)Hongkong')
        policy: min_moving_avg
    }
    Singapore {
        filter: name(keyword: 'æ–°åŠ å¡', keyword: "ðŸ‡¸ðŸ‡¬", regex: '(?i)Singapore')
        policy: min_moving_avg
    }
    ChatGPT {
        filter: name(regex: '(?i)chatgpt')
        policy: min_moving_avg
    }
    Taiwan {
        filter: name(keyword: 'å°æ¹¾', keyword: "(?i)Taiwan")
        policy: min_moving_avg
    }
    America {
        filter: name(keyword: 'ç¾Žå›½', keyword: "ðŸ‡ºðŸ‡¸", regex: '(?i)America')
        policy: min_moving_avg
    }
    Japan {
        filter: name(keyword: 'æ—¥æœ¬', keyword: "ðŸ‡¯ðŸ‡µ")
        policy: min_moving_avg
    }
    UK {
        filter: name(keyword: 'è‹±å›½')
        policy: min_moving_avg
    }
    Netflix {
        filter: name(regex: '(?i)Netflix', keyword: 'å¥ˆé£ž')
        policy: min_moving_avg
    }
}

# æ›´å¤šçš„ Routing æ ·ä¾‹è§ https://github.com/daeuniverse/dae/blob/main/docs/en/configuration/routing.md
routing {
    ### ä»¥ä¸‹æ˜¯é¢„è®¾è§„åˆ™

    # æœ¬åœ°çš„ç½‘ç»œç®¡ç†å™¨åº”è¯¥ç›´è¿žï¼Œä»¥é¿å…åœ¨ç»‘å®šWANæŽ¥å£çš„æ—¶å€™å‡ºçŽ°é”™è¯¯çš„ç½‘ç»œè¿žé€šæ€§æ£€æŸ¥ç»“æžœ
    pname(NetworkManager) -> direct

    # æŠŠå®ƒæ”¾åœ¨å‰é¢ï¼Œå¯ä»¥é˜²æ­¢å¤šæ’­åº”è¯¥å‘é€åˆ°å±€åŸŸç½‘çš„æ•°æ®åŒ…è¢«ä»£ç†è½¬å‘ã€‚
    # "dip" æ„æ€æ˜¯ç›®çš„IP.
    dip(224.0.0.0/3, 'ff00::/8') -> direct

    ### ä»¥ä¸‹æ˜¯è‡ªå®šä¹‰è§„åˆ™

    # ç¦ç”¨ h3ï¼Œå› ä¸ºå®ƒé€šå¸¸æ¶ˆè€—å¾ˆå¤š CPU å’Œå†…å­˜èµ„æº
    # l4proto(udp) && dport(443) -> block

    # å†…ç½®å‡ºç«™ï¼šblock, direct, must_rules
    # must_rules è¡¨ç¤ºä¸å°†DNSæµé‡é‡å®šå‘è‡³daeå¹¶ç»§ç»­åŒ¹é…ã€‚
    # å¯¹äºŽå•æ¡è§„åˆ™ï¼Œ"direct"å’Œ"must_direct"çš„åŒºåˆ«åœ¨äºŽ"direct"ä¼šåŠ«æŒå¹¶å¤„ç†DNSè¯·æ±‚ï¼ˆç”¨äºŽæµé‡åˆ†å‰²ä½¿ç”¨ï¼‰ï¼Œè€Œ"must_direct"ä¸ä¼šã€‚
    # å½“å­˜åœ¨ DNS è¯·æ±‚çš„å›žçŽ¯æ—¶ï¼Œ"must_direct"å¾ˆæœ‰ç”¨ã€‚
    # "must_direct" ä¹Ÿå¯ä»¥å†™ä½œ "direct(must)"ã€‚
    # åŒæ ·ï¼Œ"must_groupname"ä¹Ÿæ”¯æŒä¸åŠ«æŒã€å¤„ç† DNS æµé‡ï¼Œç›¸å½“äºŽ"groupname(must)"ã€‚
    # groupnameæŒ‡çš„æ˜¯å‡ºç«™åˆ†ç»„

    ## åŸŸåè§„åˆ™

    # åŽç¼€åŒ¹é…
    domain(suffix: v2raya.org) -> proxy_all
    # å…¨åŒ¹é…ï¼Œä¸¤ç§å†™æ³•
    domain(full: dns.google.com) -> proxy_all # equals to domain(v2raya.org) -> proxy_all
    domain(keyword: facebook) -> proxy_all

    domain(suffix: cn.bing.com) -> block
    domain(regex: '(?i)bing', keyword: bing, suffix: bing.com) -> Bing

    domain(regex: '\.goo.*\.com$') -> Google
    domain(geosite:category-ads) -> block
    domain(bilibili.com) -> direct
    # ç»„åˆè§„åˆ™
    domain(keyword: google, suffix: www.twitter.com, suffix: v2raya.org) -> proxy_all

    domain(keyword: github) -> proxy_all

    ## ç›®çš„IPè§„åˆ™
    # å•ä¸ªIPåŒ¹é…
    dip(8.8.8.8) -> direct
    # å•ä¸ªIPæ®µåŒ¹é…
    # dip(101.97.0.0/16) -> direct
    # å¤šç›®çš„IPè§„åˆ™, geoip:private è®¾ç½®å…è®¸ä½ ç›´æŽ¥è®¿é—®ç§æœ‰åœ°å€è€Œä¸æ˜¯é€šè¿‡ä»£ç†ï¼Œå¦‚æžœä½ æƒ³è®¿é—®ä»£ç†ä¸»æœºçš„ç§æœ‰ç½‘ç»œåœ°å€ï¼Œå¯ä»¥ä¿®æ”¹ä¸‹é¢é…ç½®
    dip(geoip:cn, geoip:private) -> direct
    # dip(9.9.9.9, 223.5.5.5) -> direct


    ## æºIPè§„åˆ™
    # sip(192.168.0.0/24) -> proxy_all
    sip(192.168.50.0/24) -> direct
    # å¤šæºIPè§„åˆ™
    # sip(192.168.0.6, 192.168.0.10, 192.168.0.15) -> direct


    ## ç›®çš„ç«¯å£è§„åˆ™
    # å•ä¸ªç«¯å£
    dport(80) -> direct
    # ç«¯å£èŒƒå›´
    dport(10080-30000) -> direct

    ## æºç«¯å£è§„åˆ™
    # å•ä¸ªç«¯å£
    sport(38563) -> direct
    # ç«¯å£èŒƒå›´
    sport(10080-30000) -> direct

    ## å››å±‚åè®®è§„åˆ™:
    # tcp
    l4proto(tcp) -> proxy_all
    # udp
    l4proto(udp) -> direct

    ## è¿›ç¨‹åè§„åˆ™ (å½“ç»‘å®šWANæŽ¥å£æ˜¯åªæ”¯æŒæœ¬åœ°è¿›ç¨‹)
    pname(curl) -> direct

    ## DSCPè§„åˆ™ (åŒ¹é… DSCP; å¯¹äºŽç»•è¿‡BTæœ‰ç”¨).
    # See https://github.com/daeuniverse/dae/discussions/295
    dscp(0x4) -> direct

    ## "ä¸”"è§„åˆ™
    dip(geoip:cn) && dport(80) -> direct
    dip(8.8.8.8) && l4proto(tcp) && dport(1-1023, 8443) -> proxy_all
    dip(1.1.1.1) && sip(10.0.0.1, 172.20.0.0/16) -> direct

    ## â€œéžâ€œè§„åˆ™
    # ä¸‹é¢ä»£è¡¨ï¼ŒåŸŸåä¸æ˜¯geositeç±»åž‹ä¸ºgoogle-scholaræˆ–è€…category-scholar-!cnæˆ–è€…category-scholar-cn
    !domain(geosite:google-scholar,
        geosite:category-scholar-!cn,
        geosite:category-scholar-cn
    ) -> proxy_all

    ## æ›´å¤æ‚çš„è§„åˆ™
    domain(geosite:geolocation-!cn) &&
        !domain(geosite:google-scholar,
            geosite:category-scholar-!cn,
            geosite:category-scholar-cn
        ) -> proxy_all

    ## Must rules
    # å¯¹äºŽä»¥ä¸‹è§„åˆ™ï¼ŒDNSè¯·æ±‚å°†ä¼šè¢«å¼ºåˆ¶é‡å®šå‘åˆ°daeï¼Œé™¤äº†mosdnsçš„è¯·æ±‚
    # ä¸åŒäºŽmust_direct/must_my_groupï¼Œæ¥è‡ªmosdnsçš„æµé‡ä¼šç»§ç»­åŒ¹é…å…¶ä»–è§„åˆ™
    pname(mosdns) -> must_rules
    ip(geoip:cn) -> direct
    domain(geosite:cn) -> direct

    fallback: proxy_all

    ## IPç‰ˆæœ¬è§„åˆ™:
    # IPv4
    # ipversion(4) -> block
    # IPv6
    # ipversion(6) -> ipv6_group

    ## è‡ªå®šä¹‰ DAT æ–‡ä»¶
    # domain(ext:"yourdatfile.dat:yourtag")->direct
    # dip(ext:"yourdatfile.dat:yourtag")->direct

    ## è®¾ç½® fwmarkï¼ˆFirewall Markï¼‰
    # å½“æ‚¨æƒ³è¦å°†æµé‡é‡å®šå‘åˆ°ç‰¹å®šæŽ¥å£ï¼ˆä¾‹å¦‚wireguardï¼‰æˆ–ç”¨äºŽå…¶ä»–é«˜çº§ç”¨é€”æ—¶ï¼Œæ ‡è®°éžå¸¸æœ‰ç”¨
    # ä»¥ä¸‹æ˜¯å°†Disneyçš„æµé‡é‡å®šå‘åˆ°wg0æŽ¥å£çš„è¿‡ç¨‹
    # You need set ip rule and ip table like this:
    # 1. Set all traffic with mark 0x800/0x800 to use route table 1145:
    # >> ip rule add fwmark 0x800/0x800 table 1145
    # >> ip -6 rule add fwmark 0x800/0x800 table 1145
    # 2. Set default route of route table 1145:
    # >> ip route add default dev wg0 scope global table 1145
    # >> ip -6 route add default dev wg0 scope global table 1145
    # Notice that interface wg0, mark 0x800, table 1145 can be set by preferences, but cannot conflict.
    # 3. Set routing rules in dae config file.
    domain(geosite:disney) -> direct(mark: 0x800)

    ## æºMACè§„åˆ™
    # mac('02:42:ac:11:00:02') -> direct
}
